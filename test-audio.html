<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPM Detection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .detection-results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .bpm-display {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        .audio-visualizer {
            width: 100%;
            height: 100px;
            background: #000;
            border-radius: 4px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }
        .beat-bar {
            position: absolute;
            bottom: 0;
            width: 2px;
            background: #00ff00;
            transition: height 0.1s ease;
        }
    </style>
</head>
<body>
    <h1>BPM Detection Test</h1>
    <p>This test generates audio at known BPMs to verify our detection algorithm works correctly.</p>
    
    <div class="test-container">
        <h2>Test Audio Generator</h2>
        <div class="controls">
            <button id="start120">Start 120 BPM Test</button>
            <button id="start90">Start 90 BPM Test</button>
            <button id="start60">Start 60 BPM Test</button>
            <button id="stopAudio">Stop Audio</button>
        </div>
        <div id="audioStatus" class="status info">Ready to test</div>
        <div class="audio-visualizer" id="visualizer"></div>
    </div>
    
    <div class="test-container">
        <h2>BPM Detection Results</h2>
        <div class="controls">
            <button id="startDetection">Start Detection</button>
            <button id="stopDetection">Stop Detection</button>
        </div>
        <div id="detectionStatus" class="status info">Detection not started</div>
        <div class="bpm-display" id="detectedBPM">Detected BPM: --</div>
        <div class="detection-results" id="detectionResults">
            <p>Detection results will appear here...</p>
        </div>
    </div>

    <script>
        class AudioTestGenerator {
            constructor() {
                this.audioContext = null;
                this.oscillator = null;
                this.gainNode = null;
                this.isPlaying = false;
                this.currentBPM = 0;
                this.beatInterval = null;
            }

            async init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.gainNode = this.audioContext.createGain();
                    this.gainNode.connect(this.audioContext.destination);
                    this.gainNode.gain.value = 0.3; // Moderate volume
                    return true;
                } catch (error) {
                    console.error('Error initializing audio:', error);
                    return false;
                }
            }

            startTestBPM(bpm) {
                if (this.isPlaying) {
                    this.stop();
                }

                this.currentBPM = bpm;
                const beatInterval = 60000 / bpm; // Convert BPM to milliseconds

                // Create a click sound for each beat
                this.beatInterval = setInterval(() => {
                    this.playClick();
                    this.visualizeBeat();
                }, beatInterval);

                this.isPlaying = true;
                document.getElementById('audioStatus').textContent = `Playing ${bpm} BPM test audio`;
                document.getElementById('audioStatus').className = 'status success';
            }

            playClick() {
                if (!this.audioContext) return;

                // Create a short click sound
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(1000, this.audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.1);
            }

            visualizeBeat() {
                const visualizer = document.getElementById('visualizer');
                const bar = document.createElement('div');
                bar.className = 'beat-bar';
                bar.style.left = Math.random() * 95 + '%';
                bar.style.height = '100%';
                visualizer.appendChild(bar);

                // Remove old bars
                const bars = visualizer.querySelectorAll('.beat-bar');
                if (bars.length > 20) {
                    bars[0].remove();
                }

                // Animate the bar
                setTimeout(() => {
                    bar.style.height = '0%';
                }, 50);
            }

            stop() {
                if (this.beatInterval) {
                    clearInterval(this.beatInterval);
                    this.beatInterval = null;
                }
                this.isPlaying = false;
                this.currentBPM = 0;
                document.getElementById('audioStatus').textContent = 'Audio stopped';
                document.getElementById('audioStatus').className = 'status info';
            }
        }

        class BPMDetector {
            constructor() {
                this.audioContext = null;
                this.analyser = null;
                this.microphone = null;
                this.isListening = false;
                this.beatHistory = [];
                this.lastBeatTime = 0;
                this.minBeatInterval = 200; // Minimum 200ms between beats
                this.energyHistory = [];
            }

            async init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 2048;
                    this.analyser.smoothingTimeConstant = 0.8;
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.microphone = this.audioContext.createMediaStreamSource(stream);
                    this.microphone.connect(this.analyser);
                    
                    return true;
                } catch (error) {
                    console.error('Error initializing microphone:', error);
                    return false;
                }
            }

            startDetection() {
                if (this.isListening) return;
                
                this.isListening = true;
                this.analyzeAudio();
                document.getElementById('detectionStatus').textContent = 'Listening for beats...';
                document.getElementById('detectionStatus').className = 'status success';
            }

            stopDetection() {
                this.isListening = false;
                document.getElementById('detectionStatus').textContent = 'Detection stopped';
                document.getElementById('detectionStatus').className = 'status info';
            }

            analyzeAudio() {
                if (!this.isListening) return;

                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                this.analyser.getByteTimeDomainData(dataArray);

                // Calculate energy (RMS)
                let energy = 0;
                for (let i = 0; i < bufferLength; i++) {
                    const sample = (dataArray[i] - 128) / 128;
                    energy += sample * sample;
                }
                energy = Math.sqrt(energy / bufferLength);

                // Adaptive threshold
                this.energyHistory.push(energy);
                if (this.energyHistory.length > 20) {
                    this.energyHistory.shift();
                }

                const avgEnergy = this.energyHistory.reduce((a, b) => a + b, 0) / this.energyHistory.length;
                const dynamicThreshold = Math.max(avgEnergy * 1.5, 0.01);

                // Check for beat
                const now = Date.now();
                const timeSinceLastBeat = now - this.lastBeatTime;

                if (energy > dynamicThreshold && timeSinceLastBeat > this.minBeatInterval) {
                    this.processBeat(now);
                }

                // Update display
                this.updateDisplay(energy, dynamicThreshold, avgEnergy);

                requestAnimationFrame(() => this.analyzeAudio());
            }

            processBeat(timestamp) {
                this.lastBeatTime = timestamp;
                this.beatHistory.push(timestamp);

                // Keep only last 10 beats
                if (this.beatHistory.length > 10) {
                    this.beatHistory.shift();
                }

                // Calculate BPM if we have enough beats
                if (this.beatHistory.length >= 3) {
                    const intervals = [];
                    for (let i = 1; i < this.beatHistory.length; i++) {
                        intervals.push(this.beatHistory[i] - this.beatHistory[i-1]);
                    }

                    const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                    const bpm = Math.round(60000 / avgInterval);

                    document.getElementById('detectedBPM').textContent = `Detected BPM: ${bpm}`;
                    
                    const results = document.getElementById('detectionResults');
                    results.innerHTML = `
                        <p><strong>Latest Detection:</strong></p>
                        <p>BPM: ${bpm}</p>
                        <p>Beats detected: ${this.beatHistory.length}</p>
                        <p>Average interval: ${avgInterval.toFixed(0)}ms</p>
                        <p>Intervals: ${intervals.map(i => i.toFixed(0)).join(', ')}ms</p>
                    `;
                }

                console.log(`Beat detected! Energy exceeded threshold`);
            }

            updateDisplay(energy, threshold, avgEnergy) {
                // This could be enhanced with a visual energy meter
                console.log(`Energy: ${energy.toFixed(4)}, Threshold: ${threshold.toFixed(4)}, Avg: ${avgEnergy.toFixed(4)}`);
            }
        }

        // Initialize the test
        const audioGenerator = new AudioTestGenerator();
        const bpmDetector = new BPMDetector();

        // Event listeners
        document.getElementById('start120').addEventListener('click', () => audioGenerator.startTestBPM(120));
        document.getElementById('start90').addEventListener('click', () => audioGenerator.startTestBPM(90));
        document.getElementById('start60').addEventListener('click', () => audioGenerator.startTestBPM(60));
        document.getElementById('stopAudio').addEventListener('click', () => audioGenerator.stop());

        document.getElementById('startDetection').addEventListener('click', async () => {
            const success = await bpmDetector.init();
            if (success) {
                bpmDetector.startDetection();
            } else {
                document.getElementById('detectionStatus').textContent = 'Failed to access microphone';
                document.getElementById('detectionStatus').className = 'status error';
            }
        });

        document.getElementById('stopDetection').addEventListener('click', () => bpmDetector.stopDetection());

        // Initialize audio generator
        audioGenerator.init();
    </script>
</body>
</html>
